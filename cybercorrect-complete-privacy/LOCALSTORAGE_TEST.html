<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalStorage Verification Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .tool-card {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tool-name {
            font-size: 18px;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 10px;
        }
        .storage-key {
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 5px 0;
            display: inline-block;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success {
            background: #4CAF50;
            color: white;
        }
        .status.empty {
            background: #FF9800;
            color: white;
        }
        .status.error {
            background: #f44336;
            color: white;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #0b7dda;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .summary {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            margin: 20px 0;
        }
        .data-preview {
            background: #fafafa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç LocalStorage Verification Test</h1>
    
    <div class="summary">
        <h2>Summary</h2>
        <div id="summary">Loading...</div>
    </div>

    <div>
        <button onclick="checkAllTools()">üîÑ Refresh Status</button>
        <button onclick="testDataPersistence()">üß™ Test Persistence</button>
        <button onclick="showStorageSize()">üìä Show Storage Size</button>
        <button class="danger" onclick="clearAllData()">üóëÔ∏è Clear All Tool Data</button>
    </div>

    <h2>Tool Status</h2>
    <div id="tool-status"></div>

    <script>
        const tools = [
            {
                name: 'SSP Generator',
                keys: ['ssp_sections', 'ssp_system_info', 'ssp_controls'],
                description: 'System Security Plan Generator with auto-save'
            },
            {
                name: 'DPIA Generator',
                keys: ['dpia_form_data'],
                description: 'Data Protection Impact Assessment form'
            },
            {
                name: 'Privacy Policy Generator',
                keys: ['policy_selected_regulation', 'policy_organization_type', 'policy_type'],
                description: 'Multi-regulation privacy policy generator'
            },
            {
                name: 'GDPR Data Mapper',
                keys: ['gdpr_activities', 'gdpr_selected_activity'],
                description: 'GDPR Article 30 processing activities mapper'
            },
            {
                name: 'Privacy Rights Manager',
                keys: ['privacy_rights_requests', 'privacy_rights_selected_request'],
                description: 'Data Subject Rights request management'
            },
            {
                name: 'Data Flow Mapper',
                keys: ['dataflow_nodes', 'dataflow_flows', 'dataflow_selected_node'],
                description: 'CUI data flow mapping tool'
            },
            {
                name: 'POAM Generator',
                keys: ['poam_items', 'poam_selected'],
                description: 'Plan of Action & Milestones generator'
            }
        ];

        function checkTool(tool) {
            const results = tool.keys.map(key => {
                try {
                    const data = localStorage.getItem(key);
                    return {
                        key,
                        exists: data !== null,
                        size: data ? new Blob([data]).size : 0,
                        preview: data ? (data.length > 100 ? data.substring(0, 100) + '...' : data) : null
                    };
                } catch (error) {
                    return {
                        key,
                        exists: false,
                        error: error.message
                    };
                }
            });

            return {
                name: tool.name,
                description: tool.description,
                keys: results,
                hasData: results.some(r => r.exists)
            };
        }

        function renderToolStatus(toolData) {
            const card = document.createElement('div');
            card.className = 'tool-card';
            
            const statusClass = toolData.hasData ? 'success' : 'empty';
            const statusText = toolData.hasData ? 'HAS DATA' : 'NO DATA';
            
            let html = `
                <div class="tool-name">
                    ${toolData.name}
                    <span class="status ${statusClass}">${statusText}</span>
                </div>
                <p style="color: #666; margin: 10px 0;">${toolData.description}</p>
            `;
            
            toolData.keys.forEach(keyData => {
                const keyStatus = keyData.exists ? 
                    `<span class="status success">‚úì ${(keyData.size / 1024).toFixed(2)} KB</span>` :
                    `<span class="status empty">Empty</span>`;
                
                html += `
                    <div style="margin: 10px 0;">
                        <span class="storage-key">${keyData.key}</span>
                        ${keyStatus}
                    </div>
                `;
                
                if (keyData.exists && keyData.preview) {
                    html += `<div class="data-preview">${escapeHtml(keyData.preview)}</div>`;
                }
            });
            
            card.innerHTML = html;
            return card;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function checkAllTools() {
            const container = document.getElementById('tool-status');
            container.innerHTML = '';
            
            const results = tools.map(checkTool);
            results.forEach(result => {
                container.appendChild(renderToolStatus(result));
            });
            
            updateSummary(results);
        }

        function updateSummary(results) {
            const totalTools = results.length;
            const toolsWithData = results.filter(r => r.hasData).length;
            const totalKeys = results.reduce((sum, r) => sum + r.keys.length, 0);
            const keysWithData = results.reduce((sum, r) => 
                sum + r.keys.filter(k => k.exists).length, 0
            );
            
            const totalSize = results.reduce((sum, r) => 
                sum + r.keys.reduce((keySum, k) => keySum + (k.size || 0), 0), 0
            );
            
            document.getElementById('summary').innerHTML = `
                <p><strong>Tools with Data:</strong> ${toolsWithData}/${totalTools}</p>
                <p><strong>Storage Keys Used:</strong> ${keysWithData}/${totalKeys}</p>
                <p><strong>Total Storage:</strong> ${(totalSize / 1024).toFixed(2)} KB</p>
                <p><strong>Status:</strong> 
                    ${toolsWithData === totalTools ? 
                        '<span class="status success">All tools functional</span>' : 
                        '<span class="status empty">Some tools need data</span>'}
                </p>
            `;
        }

        function testDataPersistence() {
            const testKey = 'test_persistence_' + Date.now();
            const testData = {
                timestamp: new Date().toISOString(),
                testValue: 'LocalStorage is working!',
                nested: { data: [1, 2, 3] }
            };
            
            try {
                // Write test data
                localStorage.setItem(testKey, JSON.stringify(testData));
                
                // Read it back
                const retrieved = JSON.parse(localStorage.getItem(testKey));
                
                // Verify
                const success = retrieved.testValue === testData.testValue;
                
                // Clean up
                localStorage.removeItem(testKey);
                
                if (success) {
                    alert('‚úÖ Persistence Test PASSED\\n\\nData was successfully written to and retrieved from localStorage.');
                } else {
                    alert('‚ùå Persistence Test FAILED\\n\\nData mismatch detected.');
                }
            } catch (error) {
                alert('‚ùå Persistence Test FAILED\\n\\n' + error.message);
            }
        }

        function showStorageSize() {
            let totalSize = 0;
            let itemCount = 0;
            
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length + key.length;
                    itemCount++;
                }
            }
            
            const sizeKB = (totalSize / 1024).toFixed(2);
            const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
            
            alert(
                `üìä LocalStorage Statistics\\n\\n` +
                `Total Items: ${itemCount}\\n` +
                `Total Size: ${sizeKB} KB (${sizeMB} MB)\\n` +
                `Available: ~5-10 MB per origin\\n\\n` +
                `Usage: ${(parseFloat(sizeMB) / 5 * 100).toFixed(1)}% of typical 5MB limit`
            );
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è WARNING\\n\\nThis will delete ALL tool data from localStorage!\\n\\nAre you sure?')) {
                return;
            }
            
            tools.forEach(tool => {
                tool.keys.forEach(key => {
                    localStorage.removeItem(key);
                });
            });
            
            alert('‚úÖ All tool data has been cleared!');
            checkAllTools();
        }

        // Auto-load on page load
        window.addEventListener('load', checkAllTools);
    </script>
</body>
</html>
